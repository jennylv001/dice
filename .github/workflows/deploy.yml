name: Deploy Kismet Worker & Pages

# Prevent overlapping deploys on same ref (e.g., rapid pushes) by cancelling in-progress run.
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
    paths:
      - 'kismet/worker/**'
      - 'kismet/app/**'
      - 'kismet/shared/**'
      - 'kismet/infra/wrangler.toml'
  workflow_dispatch:

jobs:
  deploy-worker:
    name: Deploy Cloudflare Worker
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[skip-deploy]') == false
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Worker deps
        working-directory: kismet/worker
        run: npm install

      - name: Wrangler Version
        run: npx wrangler --version || true

      - name: Deploy Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: kismet/worker
        run: npx wrangler deploy --config ../infra/wrangler.toml --quiet
      # Uncomment to (re)push secrets if rotating (one-time normally):
      # - name: (Optional) Update TURN secrets
      #   if: env.TURN_TOKEN_ID != ''
      #   env:
      #     TURN_TOKEN_ID: ${{ secrets.TURN_TOKEN_ID }}
      #     TURN_API_TOKEN: ${{ secrets.TURN_API_TOKEN }}
      #     CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      #     CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      #   working-directory: kismet/worker
      #   run: |
      #     echo "$TURN_TOKEN_ID" | npx wrangler secret put TURN_TOKEN_ID --config ../infra/wrangler.toml --quiet
      #     echo "$TURN_API_TOKEN" | npx wrangler secret put TURN_API_TOKEN --config ../infra/wrangler.toml --quiet

  deploy-pages:
    name: Deploy Cloudflare Pages
    runs-on: ubuntu-latest
    needs: deploy-worker
    if: contains(github.event.head_commit.message, '[skip-deploy]') == false
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install App deps
        working-directory: kismet/app
        run: npm install

      - name: Build App
        working-directory: kismet/app
        run: npm run build

      - name: Deploy Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: kismet/app
        run: npx wrangler pages deploy dist --project-name kismet-app --commit-dirty=true

# Required GitHub Secrets:
#   CLOUDFLARE_API_TOKEN   -> API token scopes: Account:Read, Workers Scripts:Edit, Workers KV Storage:Edit, Pages:Edit (and R2:Read/Write if tournaments later)
#   CLOUDFLARE_ACCOUNT_ID  -> Cloudflare account ID (from dashboard URL)
# Optional Secrets (if rotating via workflow):
#   TURN_TOKEN_ID, TURN_API_TOKEN -> Added once manually with `wrangler secret put` or via optional step above.
# Skip deploy by adding [skip-deploy] to commit message.
# Preview environments: convert to trigger on pull_request & use `wrangler pages deploy --branch <name>` if desired.