name: Deploy Kismet Worker & Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'kismet/worker/**'
      - 'kismet/app/**'
      - 'kismet/shared/**'
      - 'kismet/infra/wrangler.toml'
  workflow_dispatch:

jobs:
  deploy-worker:
    name: Deploy Cloudflare Worker
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[skip-deploy]') == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Worker deps
        working-directory: kismet/worker
        run: npm ci

      - name: Wrangler Version
        run: npx wrangler --version || true

      - name: Deploy Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: kismet/worker
        run: npx wrangler deploy --config ../infra/wrangler.toml --quiet

  deploy-pages:
    name: Deploy Cloudflare Pages
    runs-on: ubuntu-latest
    needs: deploy-worker
    if: contains(github.event.head_commit.message, '[skip-deploy]') == false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install App deps
        working-directory: kismet/app
        run: npm ci

      - name: Build App
        working-directory: kismet/app
        run: npm run build

      - name: Deploy Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: kismet/app
        run: npx wrangler pages deploy dist --project-name kismet-app --commit-dirty=true

# Required GitHub Secrets:
#   CLOUDFLARE_API_TOKEN  -> API token with Workers Scripts:Edit, KV:Edit, Pages:Edit permissions.
#   CLOUDFLARE_ACCOUNT_ID -> Your Cloudflare account ID.
# Optional Secrets:
#   TURN_API_TOKEN        -> If not already stored as a Cloudflare secret; can add a step to wrangler secret put.
# Skip deploy by adding [skip-deploy] to commit message.